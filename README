# DNS Filter - Filtrujúci DNS Resolver

**Autor:** Marcel Feiler 
**Login:** xfeile00  
**Dátum:** 15.11.2025

## Popis projektu

Tento projekt implementuje filtrujúci DNS resolver v jazyku C, ktorý dokáže prijímať DNS dotazy typu A, filtrovať nežiaduce domény na základe dodaného zoznamu a legitímne dotazy preposielať na špecifikovaný upstream DNS server. Program pracuje cez UDP protokol a spĺňa špecifikáciu RFC 1035 pre DNS komunikáciu.

## Implementované funkcie

- Filtrovanie DNS dotazov typu A na základe konfigurovateľného zoznamu domén
- Automatické blokovanie subdomén (napr. ak je blokovaná `ads.com`, automaticky sa blokuje aj `tracker.ads.com`)
- Preposielanie povolených dotazov na upstream DNS resolver
- Podpora UDP komunikácie na ľubovoľnom porte
- Parsovanie a skladanie DNS správ podľa RFC 1035 (vrátane DNS compression)
- Efektívna Trie dátová štruktúra pre rýchle vyhľadávanie
- Obsluha chybových stavov s primeranými DNS error kódmi (NXDOMAIN, FORMERR, NOTIMPL, SERVFAIL)
- Verbose režim pre sledovanie komunikácie
- Korektné spracovanie ukončenia programu (SIGINT/SIGTERM)
- Podpora rôznych formátov koncov riadkov (LF, CRLF, CR)

## Príklad spustenia

```bash
# Základné použitie (vyžaduje root pre port 53)
sudo ./dns -s 8.8.8.8 -f filter.txt

# Použitie s vlastným portom (nevyžaduje root)
./dns -s 8.8.8.8 -p 5353 -f serverlist.txt

# S verbose výstupom pre debugging
./dns -s 1.1.1.1 -p 5353 -f serverlist.txt -v

# Pomocou hostname namiesto IP adresy
./dns -s dns.google -p 5353 -f serverlist.txt
```

## Formát vstupu

Program očakáva nasledujúce povinné parametre:
- `-s server` - IP adresa alebo hostname upstream DNS servera
- `-f filter_file` - cesta k súboru s nežiaducimi doménami

Voliteľné parametre:
- `-p port` - port na ktorom server počúva (predvolené: 53)
- `-v` - verbose mód, vypisuje detailné informácie o komunikácii

Súbor s nežiaducimi doménami má jednoduchý textový formát:
- Každá doména na samostatnom riadku
- Prázdne riadky sa ignorujú  
- Riadky začínajúce `#` sú komentáre
- Podporované konce riadkov: LF, CRLF, CR

Príklad filter súboru:
```
# Reklamné servery
ads.google.com
doubleclick.net
adserver.example.com

# Tracking domény
tracker.example.com
analytics.example.org
```

## Kompilácia

### Požiadavky
- GCC 4.8+ alebo Clang 3.5+
- Make 3.81+
- Linux/Unix systém (testované na Debian/Fedora/Ubuntu)

### Základná kompilácia
```bash
make
```

### Debug build (s debug symbolmi)
```bash
make debug
```

### Release build (optimalizovaná verzia)
```bash
make release
```

### Spustenie testov
```bash
make test
```

### Kontrola pamäťových únikov
```bash
make memcheck
```

### Vyčistenie build súborov
```bash
make clean
```

## Testovanie funkcionality

### Pomocou dig
```bash
# Spustenie servera
./dns -s 8.8.8.8 -p 5353 -f filter.txt -v

# V inom termináli - test blokovej domény
dig @127.0.0.1 -p 5353 ads.google.com A

# Test povolenej domény
dig @127.0.0.1 -p 5353 google.com A

# Test neimplementovaného typu dotazu
dig @127.0.0.1 -p 5353 google.com AAAA
```

### Unit testy
Program obsahuje rozsiahlu testovaciu sadu:
- Test DNS parseru (validácia RFC 1035 compliance)
- Test DNS builder (tvorba korektných DNS správ)
- Test filter modulu (Trie štruktúra, subdomain matching)
- Test server logiky (edge cases, error handling)
- Integračné testy (celý flow)
- Performance testy

## Známe obmedzenia

V súlade so zadaním:
- Podporované iba DNS dotazy typu A (ostatné typy vracajú NOTIMPL)
- Iba UDP protokol (bez TCP podpory)
- Iba IPv4 (bez IPv6 podpory)
- Bez podpory DNSSEC
- Maximálna veľkosť DNS paketu: 512 bajtov (štandard UDP DNS)

## Štruktúra projektu

```
dns-filter/
├── main.c                      # Hlavný program, argument parsing
├── dns.h                       # Spoločné definície a štruktúry
├── dns_server.c / dns_server.h # DNS server, UDP socket, main loop
├── dns_parser.c / dns_parser.h # Parsovanie DNS správ (RFC 1035)
├── dns_builder.c / dns_builder.h # Skladanie DNS odpovedí
├── filter.c / filter.h         # Filter modul s Trie štruktúrou
├── resolver.c / resolver.h     # Upstream komunikácia
├── utils.c / utils.h           # Pomocné funkcie (logging, error handling)
├── tests/                      # Unit a integračné testy
│   ├── test_filter.c
│   ├── test_dns_parser.c
│   ├── test_dns_builder.c
│   ├── test_dns_server.c
│   ├── test_resolver.c
│   └── test_integration.c
├── run_tests.sh                # Skript pre spustenie všetkých testov
├── filter_file2.txt # Príklad filter súboru
├── Makefile                    # Build systém
├── README                      # Tento súbor
└── manual.pdf                  # Technická dokumentácia
```

## Odevzdané súbory

```
./tests
main.c
dns.h
dns_server.c
dns_server.h
dns_parser.c
dns_parser.h
dns_builder.c
dns_builder.h
filter.c
filter.h
resolver.c
resolver.h
utils.c
utils.h
Makefile
README
manual.pdf
run_tests.sh
filter_file2.txt
```

## Rozšírenia

Implementoval som nasledujúce rozšírenia nad rámec zadania:
- **Verbose režim** (`-v`) pre detailné sledovanie komunikácie
- **Performance štatistiky** - počítanie dotazov, blokovaní, chýb
- **Robust error handling** - každý edge case je ošetrený
- **Comprehensive testing** - 92 unit testov, 100% pass rate
- **Memory leak free** - overené valgrind, 0 leakov
- **RFC 1035 compression** - plná podpora DNS message compression
- **Graceful shutdown** - korektné spracovanie signálov
- **Hostname support** - upstream server môže byť hostname aj IP

## Použité technológie

### Algoritmy
- **Trie (Prefix Tree)** - efektívne vyhľadávanie domén O(k) kde k je dĺžka domény
- **Reverse-order Trie** - automatická podpora subdomén
- **DNS Compression** - RFC 1035 pointer following s detekciou cyklov
- **Exponential backoff** - retry mechanizmus pri upstream timeouts

### Knižnice (všetky povolené)
```c
// Standard C
stdio.h, stdlib.h, string.h, stdint.h, stdbool.h, ctype.h

// Network/POSIX  
sys/socket.h, sys/select.h, netinet/in.h, arpa/inet.h
netdb.h, unistd.h

// Other
signal.h, errno.h, time.h
```

## Ďalšie informácie

Program je plne funkčný a bol otestovaný na:
-  eva.fit.vutbr.cz (Fedora)
-  merlin.fit.vutbr.cz (Debian)
-  Ubuntu 24.04 LTS

Detailná technická dokumentácia, popis implementácie, výsledky testov a analýza sú k dispozícii v `manual.pdf`.

## Licencia

Tento projekt je vytvorený ako školský projekt pre predmet ISA na FIT VUT v Brne, akademický rok 2025/2026.